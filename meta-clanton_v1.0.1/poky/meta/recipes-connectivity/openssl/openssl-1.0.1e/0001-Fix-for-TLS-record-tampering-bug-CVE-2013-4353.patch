From 197e0ea817ad64820789d86711d55ff50d71f631 Mon Sep 17 00:00:00 2001
From: "Dr. Stephen Henson" <steve@openssl.org>
Date: Mon, 6 Jan 2014 14:35:04 +0000
Subject: [PATCH] Fix for TLS record tampering bug CVE-2013-4353

Upstream-Status: Backport
commit 197e0ea817ad64820789d86711d55ff50d71f631 upstream

 ssl/s3_both.c |    6 +++++-
 3 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/ssl/s3_both.c b/ssl/s3_both.c
index 1e5dcab..53b9390 100644
--- a/ssl/s3_both.c
+++ b/ssl/s3_both.c
@@ -210,7 +210,11 @@ static void ssl3_take_mac(SSL *s)
 	{
 	const char *sender;
 	int slen;
-
+	/* If no new cipher setup return immediately: other functions will
+	 * set the appropriate error.
+	 */
+	if (s->s3->tmp.new_cipher == NULL)
+		return;
 	if (s->state & SSL_ST_CONNECT)
 		{
 		sender=s->method->ssl3_enc->server_finished_label;
-- 
1.7.5.4

